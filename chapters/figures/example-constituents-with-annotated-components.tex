\documentclass[../../document.tex]{subfiles}

\begin{document}
   \begin{tikzpicture}[
       edge from parent path={(\tikzparentnode.south) -- ++(0,-1ex) -| (\tikzchildnode.north)},
       every path/.style={line width=.2ex},
       level distance=4.5ex,
 %      node distance=3ex,
       anchor=center,
       every node/.style={font=\small},
       draw=none,
       rounded corners=0
     ]
     \matrix (pos) [matrix of nodes, outer sep=0pt, inner sep=0pt, row sep=0pt, column sep=7pt] {
       \tn{where}\strut  & \tn{the}\strut  & \tn{survey}\strut   & \tn{was}\strut  & \tn{carried}\strut  & \tn{out}\strut  \\};

     \node[fit=(pos-1-2) (pos-1-3), outer sep=0pt, inner sep=0pt] (npanc) {\strut};
     
     
     \begin{scope}[every node/.style={inner sep=2pt, font=\small}]
         \node[above=24ex of pos-1-2] (sbar) {\cn{sbar}}
         child { node (s) {\cn{s}}
             child { node[xshift=1em] (vp1) {\cn{vp}}
                 child { node[xshift=1.5em] (vp2) {\cn{vp}}
                     child { node[above=5.5ex of pos-1-1] (wh) {\cn{wh}} child {
                             node[above=1ex of pos-1-1] (term0) {\cn{wrb}}
                             edge from parent[double]}}
                     child {
                         node[above=1ex of pos-1-5] (term4) {\cn{vbn}}
                             edge from parent[double]}
                     child { node[above=5.5ex of pos-1-6] (prt) {\cn{prt}} child {
                             node[above=1ex of pos-1-6] (term5) {\cn{rp}}
                             edge from parent[double]}}}
                 child {
                     node[above=1ex of pos-1-4] (term3) {\cn{vbd}}
                             edge from parent[double]}
                 edge from parent[double]}
             child { node[above=5.5ex of npanc] (np) {\cn{np}}
                 child { node[above=1ex of pos-1-2] (term1) {\cn{pt}} }
                 child {
                     node[above=1ex of pos-1-3] (term2) {\cn{nn}}
                             edge from parent[double]}}
                 edge from parent[double]};
     \end{scope}
     \draw
         (term0) -- (pos-1-1)
         (term1) -- (pos-1-2)
         (term2) -- (pos-1-3)
         (term3) -- (pos-1-4)
         (term4) -- (pos-1-5)
         (term5) -- (pos-1-6);

      
      % redraw corssing edges with white foundation
      \begin{scope}
      	%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
      	% redraw edge to term4, to avoid filling its gap by the edge to term5
      	\draw[double] (vp2.south) -- ++(0,-1ex) -| (term4.north);
      	%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

        \draw[white, line width=1ex] (vp1.south) -- ++(0,-1ex) -| (term3.north);
        \draw (vp1.south) -- ++(0,-1ex) -| (vp2.north);
        \draw[double] (vp1.south) -- ++(0,-1ex) -| (term3.north);

        \draw[white, line width=.7ex] (s.south) ++(.5pt,-.5ex) -| (np.north);
        \draw (s.south) -- ++(0,-1ex) -| (np.north);
        \draw[double] (s.south) -- ++(0,-1ex) -| (vp1.north);
      \end{scope}

        \coordinate[right=1em of pos] (highlights);
        \begin{scope}[gray,every node/.style={align=center, text width=3.5cm}]
          \draw (sbar.north-|highlights)
                    edge[decorate,decoration=brace]
                    node[right,text width=2cm] (cnlabel) {constituent symbols}
                (prt.south-|highlights);
            \node at (cnlabel|-term1) {\abrv{pos} symbols};
            \node at (cnlabel|-pos) {tokens};
        \end{scope}


    \matrix[right=3cm of pos.south east, anchor=south west] (rpos) [matrix of nodes, outer sep=0pt, inner sep=0pt, row sep=2ex, column sep=5pt] {
      \cn{wrb}   & \cn{pt}  & \cn{nn}  & \cn{vbd} & \cn{vbn} & \cn{rp}  \\
      where & the & survey  & was & carried & out \\};

    \begin{scope}[every node/.style={inner sep=2pt, font=\small}, level distance=4ex]
        \node[above=21.5ex of rpos-1-4, xshift=-1ex] (sbar) {\cn{sbar}}
        child { node {\cn{s}} edge from parent[double]
            [sibling distance=5.5em]
            child { node {\cn{vp}}  edge from parent[double]
                [sibling distance=4.5em]
                child { node {\cn{vp}}
                    [sibling distance=2em]
                    child { node (wh) {\cn{wh}}
                        child {node  {1} edge from parent[double]}}
                    child { node[yshift=-4ex] {5}  edge from parent[double]}
                    child { node {\cn{prt}}
                        child { node {6} edge from parent[double]}}}
                child { node[yshift=-8ex] {4} edge from parent[double]}}
            child { node[yshift=-8ex] {\cn{np}}
                [sibling distance=2em]
                child { node {2} }
                child { node {3} edge from parent[double]}}};
    \end{scope}
    \coordinate[left=1ex of wh] (highlights);

    \begin{scope}[gray,every node/.style={align=left, text width=3.5cm, draw}]
      \draw (wh.south-|highlights)
                edge[decorate,decoration={brace,aspect=0.45}]
            (sbar.north-|highlights);
    \end{scope}

   \end{tikzpicture}
\end{document}
